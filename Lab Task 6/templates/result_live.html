<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Live Processing - AI Video Object Counter</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="/static/css/style.css" rel="stylesheet">
  </head>
  <body>
    <nav class="navbar navbar-dark bg-dark">
      <div class="container-fluid">
        <a class="navbar-brand" href="/">AI Video Object Counter</a>
      </div>
    </nav>

    <main class="container my-4">
      <div class="row">
        <div class="col-md-8">
          <div class="card shadow-sm">
            <div class="card-body text-center">
              <h5 class="card-title">Live Processing</h5>
              <p class="text-muted">Watch processed frames as they are produced.</p>

              <div class="border rounded d-inline-block overflow-hidden" style="max-width:100%">
                <img id="live-stream" src="/stream/{{ job_id }}" alt="live stream" style="max-width:100%; height:auto; display:block;" />
              </div>

              <div class="mt-3">
                <div class="progress" style="height: 14px;"><div id="live-progress" class="progress-bar" style="width:0%">0%</div></div>
                <div id="live-status" class="mt-2 text-muted small">Starting...</div>
              </div>

            </div>
          </div>
        </div>

        <div class="col-md-4">
          <div class="card shadow-sm mb-3">
            <div class="card-body">
              <h6 class="card-subtitle mb-2 text-muted">Job Info</h6>
              <ul class="list-unstyled">
                <li><strong>Job ID:</strong> {{ job_id }}</li>
                <li><strong>Status:</strong> <span id="job-status">queued</span></li>
                <li><strong>Count:</strong> <span id="job-count">0</span></li>
              </ul>
              <div id="done-actions" class="d-none mt-3">
                <a id="view-output" class="btn btn-primary" href="#">View processed video</a>
                <a class="btn btn-outline-secondary ms-2" href="/">Process another</a>
              </div>
            </div>
          </div>

          <div class="card shadow-sm">
            <div class="card-body">
              <h6 class="card-subtitle mb-2 text-muted">Notes</h6>
              <p class="small text-muted">If the stream freezes, the job may have completed â€” use the View button to open the output.</p>
            </div>
          </div>
        </div>
      </div>
    </main>

    <script>
      const jobId = "{{ job_id }}";
      const statusEl = document.getElementById('job-status');
      const countEl = document.getElementById('job-count');
      const progressBar = document.getElementById('live-progress');
      const liveStatus = document.getElementById('live-status');
      const doneActions = document.getElementById('done-actions');
      const viewOutput = document.getElementById('view-output');

      async function poll() {
        try {
          const res = await fetch(`/job_status/${jobId}`);
          if (!res.ok) { liveStatus.textContent = 'Job missing'; return; }
          const json = await res.json();
          statusEl.textContent = json.status;
          countEl.textContent = json.total || 0;

          // rudimentary progress using total frames processed (frame_idx) isn't available reliably
          // show indeterminate progress while processing
          if (json.status === 'processing') {
            liveStatus.textContent = 'Processing...';
            progressBar.style.width = '40%';
            progressBar.textContent = 'Processing';
          } else if (json.status === 'done' || json.finished) {
            liveStatus.textContent = 'Completed';
            progressBar.style.width = '100%';
            progressBar.textContent = '100%';
            doneActions.classList.remove('d-none');
            if (json.output) {
              viewOutput.href = json.output;
            }
            return; // stop polling
          } else if (json.status === 'error') {
            liveStatus.textContent = 'Error';
            progressBar.classList.add('bg-danger');
            doneActions.classList.remove('d-none');
            return;
          }
        } catch (e) {
          liveStatus.textContent = 'Status error';
        }
        setTimeout(poll, 1000);
      }

      poll();
    </script>
  </body>
</html>
